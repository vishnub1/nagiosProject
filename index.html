<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nagios Alert Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    h1, h2 {
      margin-top: 20px;
    }
    select, input[type="file"] {
      margin-right: 10px;
      padding: 5px;
    }
    .charts-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-top: 20px;
    }
    .chart-box {
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      flex: 1;
      min-width: 400px;
    }
    .control-section {
      margin-bottom: 20px;
    }
    #filteredChart {
      width: 100%;
      max-width: 1000px;
      height: 500px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Nagios Alert Dashboard</h1>

  <div>
    <label>Upload JSON File:</label>
    <input type="file" id="fileUpload" accept=".json">

    <label for="dateSelect">Select Date:</label>
    <select id="dateSelect">
      <option value="all">All Dates</option>
    </select>
  </div>

  <div class="charts-container">
    <div class="chart-box">
      <h2>Alert State Pie Chart</h2>
      <div id="statePieChart"></div>
    </div>
    <div class="chart-box">
      <h2>Top Critical Hosts</h2>
      <div id="criticalChart"></div>
    </div>
    <div class="chart-box">
      <h2>Top Warning Hosts</h2>
      <div id="warningChart"></div>
    </div>
    <div class="chart-box">
      <h2>Top Services</h2>
      <div id="serviceChart"></div>
    </div>
  </div>

  <h2>Filter by Service or State</h2>

  <div class="control-section">
    <label for="serviceSelect">Select Service:</label>
    <select id="serviceSelect">
      <option value="">-- Choose Service --</option>
    </select>

    <label for="stateSelect">Select State:</label>
    <select id="stateSelect">
      <option value="">-- Choose State --</option>
    </select>
  </div>

  <div id="filteredChart"></div>

  <script>
    let jsonData = [];

    document.getElementById("fileUpload").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          jsonData = JSON.parse(event.target.result);
          populateDates(jsonData);
          populateDropdowns(jsonData);
          renderAllCharts(jsonData);
        } catch (err) {
          alert("Invalid JSON file.");
        }
      };
      reader.readAsText(file);
    });

    document.getElementById("dateSelect").addEventListener("change", () => {
      const selectedDate = document.getElementById("dateSelect").value;
      const filteredData = selectedDate === "all" ? jsonData : jsonData.filter(row => row.Date === selectedDate);
      renderAllCharts(filteredData);
    });

    function populateDates(data) {
      const dateSet = new Set(data.map(d => d.Date));
      const select = document.getElementById("dateSelect");
      select.innerHTML = '<option value="all">All Dates</option>';
      [...dateSet].sort().forEach(date => {
        const opt = document.createElement("option");
        opt.value = date;
        opt.textContent = date;
        select.appendChild(opt);
      });
    }

    function populateDropdowns(data) {
      const services = new Set();
      const states = new Set();

      data.forEach(alert => {
        if (alert["Service"]) services.add(alert["Service"]);
        if (alert["State"]) states.add(alert["State"]);
      });

      const serviceSelect = document.getElementById("serviceSelect");
      const stateSelect = document.getElementById("stateSelect");

      serviceSelect.innerHTML = '<option value="">-- Choose Service --</option>';
      stateSelect.innerHTML = '<option value="">-- Choose State --</option>';

      [...services].sort().forEach(service => {
        const opt = document.createElement("option");
        opt.value = service;
        opt.textContent = service;
        serviceSelect.appendChild(opt);
      });

      [...states].sort().forEach(state => {
        const opt = document.createElement("option");
        opt.value = state;
        opt.textContent = state;
        stateSelect.appendChild(opt);
      });
    }

    document.getElementById("serviceSelect").addEventListener("change", () => {
      document.getElementById("stateSelect").value = "";
      const selectedService = document.getElementById("serviceSelect").value;
      if (selectedService) renderHostBarChart(jsonData, "Service", selectedService);
    });

    document.getElementById("stateSelect").addEventListener("change", () => {
      document.getElementById("serviceSelect").value = "";
      const selectedState = document.getElementById("stateSelect").value;
      if (selectedState) renderHostBarChart(jsonData, "State", selectedState);
    });

    function renderAllCharts(data) {
      renderStatePieChart(data);
      renderTopHostsChart(data, "CRITICAL", "criticalChart", "Top Hosts in CRITICAL");
      renderTopHostsChart(data, "WARNING", "warningChart", "Top Hosts in WARNING");
      renderTopServicesChart(data);
    }

    function renderStatePieChart(data) {
      const stateCount = {};
      data.forEach(row => {
        if (row.State) {
          stateCount[row.State] = (stateCount[row.State] || 0) + 1;
        }
      });
      const states = Object.keys(stateCount);
      const values = Object.values(stateCount);

      const pieData = [{ labels: states, values: values, type: 'pie' }];
      const layout = { title: "Alert State Distribution" };
      Plotly.newPlot('statePieChart', pieData, layout);
    }

    function renderTopHostsChart(data, state, divId, title) {
      const counts = {};
      data.filter(d => d.State === state).forEach(row => {
        const host = row.Host || "Unknown";
        counts[host] = (counts[host] || 0) + 1;
      });
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
      const hosts = sorted.map(entry => entry[0]);
      const values = sorted.map(entry => entry[1]);

      const trace = { type: 'bar', x: hosts, y: values, marker: { color: 'salmon' } };
      const layout = { title: title, xaxis: { tickangle: -45 } };
      Plotly.newPlot(divId, [trace], layout);
    }

    function renderTopServicesChart(data) {
      const serviceCount = {};
      data.forEach(row => {
        const service = row.Service || "Unknown";
        serviceCount[service] = (serviceCount[service] || 0) + 1;
      });
      const sorted = Object.entries(serviceCount).sort((a, b) => b[1] - a[1]);
      const services = sorted.map(entry => entry[0]);
      const counts = sorted.map(entry => entry[1]);

      const trace = { type: 'bar', x: services, y: counts, marker: { color: 'steelblue' } };
      const layout = { title: "Top Alerted Services", xaxis: { tickangle: -45 } };
      Plotly.newPlot('serviceChart', [trace], layout);
    }

    function renderHostBarChart(data, filterType, filterValue) {
      const filtered = data.filter(alert => alert[filterType] === filterValue);
      const hostCounts = {};

      filtered.forEach(alert => {
        const host = alert["Host"] || "Unknown";
        hostCounts[host] = (hostCounts[host] || 0) + 1;
      });

      const sorted = Object.entries(hostCounts).sort((a, b) => b[1] - a[1]);
      const hosts = sorted.map(entry => entry[0]);
      const counts = sorted.map(entry => entry[1]);

      const barData = [{
        type: "bar",
        x: hosts,
        y: counts,
        marker: { color: 'rgb(100, 149, 237)' }
      }];

      const layout = {
        title: `Hosts with Alerts filtered by ${filterType}: ${filterValue}`,
        xaxis: { title: "Host", tickangle: -45, automargin: true },
        yaxis: { title: "Alert Count" },
        margin: { t: 60, b: 120 }
      };

      Plotly.newPlot('filteredChart', barData, layout);
    }
  </script>
</body>
</html>
